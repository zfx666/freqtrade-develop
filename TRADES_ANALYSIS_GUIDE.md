# 交易记录分析指南

## 功能说明

策略已经增强，可以在回测时自动记录每笔交易的详细信息，并导出到CSV文件供分析。

## 修改内容

### 1. 策略代码增强

在 `Bollinger4h1hStructureStrategy.py` 中添加了交易记录跟踪功能：

- **`__init__` 方法**: 添加 `self.trades_history` 列表用于存储交易记录
- **`confirm_trade_entry` 方法**: 在确认入场时记录交易开仓信息
- **`confirm_trade_exit` 方法**: 在确认出场时更新交易平仓信息
- **`_dump_trades_history` 方法**: 导出交易记录到CSV文件

### 2. 交易记录包含的信息

每笔交易记录包含以下字段：

| 字段 | 说明 |
|------|------|
| 交易ID | 交易序号 |
| 交易对 | 如 BTC/USDT |
| 开仓时间 | 入场时间 |
| 开仓价格 | 入场价格 |
| 平仓时间 | 出场时间 |
| 平仓价格 | 出场价格 |
| 平仓原因 | 出场原因（止损、止盈、结构弱等） |
| 盈亏百分比 | 盈亏百分比 |
| 持仓小时 | 持仓时长（小时） |
| 布林宽度 | 入场时的布林带宽度 |
| Armed状态 | 入场时的Armed状态 |
| HLH信号 | 入场时的HLH信号 |

## 使用方法

### 步骤1：运行回测

```bash
freqtrade backtesting \
  --strategy Bollinger4h1hStructureStrategy \
  --config user_data/config_bollinger_4h1h.json \
  --timerange 20241010-20251010
```

回测完成后，交易记录会自动导出到：
```
user_data/debug/trades_history_<交易对>.csv
```

例如：
- `user_data/debug/trades_history_BTC_USDT.csv`
- `user_data/debug/trades_history_ETH_USDT.csv`

### 步骤2：分析交易记录

运行分析工具：

```bash
python analyze_trades_csv.py
```

工具会自动查找并分析所有交易记录CSV文件。

## 分析报告内容

分析工具会提供以下统计信息：

### 1. 基本统计
- 总交易数
- 盈利交易数和占比
- 亏损交易数和占比

### 2. 胜率分析
- 胜率百分比

### 3. 盈亏分析
- 平均盈利
- 平均亏损
- 盈亏比（平均盈利/平均亏损）
- 最大盈利
- 最大亏损
- 总盈利
- 总亏损
- 净盈利
- 盈利因子（总盈利/总亏损）

### 4. 持仓时间分析
- 平均持仓时长
- 最长持仓
- 最短持仓

### 5. 退出原因分析
- 各种退出原因的分布
- 每种退出原因的平均盈亏

### 6. 盈利分布
- 不同盈亏区间的交易分布
- 可视化柱状图

### 7. 策略质量评估
- 优秀：胜率≥50% 且 盈亏比≥2
- 良好：胜率≥40% 且 盈亏比≥1.5
- 一般：胜率≥30% 且 盈亏比≥1.2
- 需要优化：低于上述标准

## 示例输出

```
======================================================================
📊 交易记录分析
======================================================================

📂 文件: user_data/debug/trades_history_BTC_USDT.csv

✅ 成功读取 45 笔交易记录

✅ 找到 45 笔已完成交易

======================================================================
📊 交易统计分析
======================================================================

📈 基本统计
----------------------------------------------------------------------
  总交易数:            45 笔
  盈利交易:            18 笔  ( 40.0%)
  亏损交易:            27 笔  ( 60.0%)

🎯 胜率分析
----------------------------------------------------------------------
  胜率:             40.00%

💰 盈亏分析
----------------------------------------------------------------------
  平均盈利:          3.45%
  平均亏损:         -1.02%
  盈亏比:            3.38  (平均盈利/平均亏损)
  
  最大盈利:          8.23%
  最大亏损:         -1.20%
  
  总盈利:           62.10%
  总亏损:          -27.54%
  净盈利:           34.56%
  盈利因子:          2.25  (总盈利/总亏损)

⏱️  持仓时间分析
----------------------------------------------------------------------
  平均持仓:          24 小时 (1.0 天)
  最长持仓:          72 小时 (3.0 天)
  最短持仓:           1 小时

🚪 退出原因分析
----------------------------------------------------------------------
  stoploss              18 笔 ( 40.0%)  平均:  -1.00%
  roi                   15 笔 ( 33.3%)  平均:   5.20%
  below_lower           12 笔 ( 26.7%)  平均:  -0.50%

📊 盈利分布
----------------------------------------------------------------------
  <-5%            0 笔 (  0.0%)  
  -5%~-3%         0 笔 (  0.0%)  
  -3%~-1%        27 笔 ( 60.0%)  ██████████████████████████████
  -1%~0%          0 笔 (  0.0%)  
  0%~1%           3 笔 (  6.7%)  ███
  1%~3%           5 笔 ( 11.1%)  █████
  3%~5%           7 笔 ( 15.6%)  ███████
  >5%             3 笔 (  6.7%)  ███

======================================================================
🎯 关键指标总结
======================================================================
  ✅ 胜率:          40.00%
  💰 盈亏比:        3.38
  📈 盈利因子:      2.25
  💵 净盈利:        34.56%
  📊 平均单笔:      0.77%
======================================================================

📝 策略评估
----------------------------------------------------------------------
  策略质量: ✅ 良好

📄 分析报告已保存: user_data/debug/trades_history_BTC_USDT_analysis.txt
```

## 注意事项

1. **交易记录自动导出**：每次回测结束后，交易记录会自动保存到 CSV 文件
2. **多交易对支持**：如果回测多个交易对，会为每个交易对生成单独的 CSV 文件
3. **数据持久化**：每次回测都会生成新的交易记录文件，不会覆盖旧文件（除非交易对相同）
4. **实时统计**：策略在导出交易记录时会打印简单的统计信息到日志

## 文件位置

- **策略文件**: `user_data/strategies/Bollinger4h1hStructureStrategy.py`
- **分析工具**: `analyze_trades_csv.py`
- **交易记录**: `user_data/debug/trades_history_*.csv`
- **分析报告**: `user_data/debug/trades_history_*_analysis.txt`

## 下一步

1. 运行回测生成交易记录
2. 使用 `analyze_trades_csv.py` 分析结果
3. 根据分析报告优化策略参数
4. 重复上述过程直到满意




