# ğŸ“Š ç­–ç•¥æ›´æ–°ï¼šå®æ—¶å¸ƒæ—å¸¦è®¡ç®—æ¨¡å¼

## ğŸ¯ æ›´æ–°æ¦‚è¿°

ç­–ç•¥å·²ä»**4hå‘¨æœŸå¸ƒæ—å¸¦åˆå¹¶æ¨¡å¼**æ”¹ä¸º**1hå®æ—¶å¸ƒæ—å¸¦è®¡ç®—æ¨¡å¼**ã€‚

---

## ğŸ”„ ä¸»è¦å˜åŒ–

### 1. **å¸ƒæ—å¸¦è®¡ç®—æ–¹å¼**

| é¡¹ç›® | ä¿®æ”¹å‰ | ä¿®æ”¹å |
|------|--------|--------|
| **æ•°æ®æº** | 4hå‘¨æœŸKçº¿ | 1hå‘¨æœŸKçº¿ï¼ˆå®æ—¶ï¼‰ |
| **è®¡ç®—æ–¹å¼** | è·å–4hæ•°æ®å¹¶åˆå¹¶åˆ°1h | æ¯å°æ—¶é‡æ–°è®¡ç®—å¸ƒæ—å¸¦ |
| **æ›´æ–°é¢‘ç‡** | æ¯4å°æ—¶æ›´æ–°ä¸€æ¬¡ | æ¯1å°æ—¶æ›´æ–°ä¸€æ¬¡ |
| **å“åº”é€Ÿåº¦** | è¾ƒæ…¢ï¼ˆ4hå»¶è¿Ÿï¼‰ | å¿«é€Ÿï¼ˆ1hå®æ—¶ï¼‰ |

### 2. **Armedè§¦å‘æ¡ä»¶**

**ä¿®æ”¹å‰**ï¼š
```python
# åŸºäº4hæ•°æ®
is_armed_4h = (å®½åº¦ >= é˜ˆå€¼) AND (4hæ”¶ç›˜ä»· > 4hä¸Šè½¨)
```

**ä¿®æ”¹å**ï¼š
```python
# åŸºäº1hå®æ—¶æ•°æ®
is_armed = (å®½åº¦ < é˜ˆå€¼) AND (1hæ”¶ç›˜ä»· > 1hä¸Šè½¨)
         â†‘ ç¼©å£åˆ¤æ–­     â†‘ çªç ´åˆ¤æ–­
```

**æ³¨æ„**ï¼šå®½åº¦åˆ¤æ–­ä» `>=` æ”¹ä¸º `<`ï¼Œè¡¨ç¤º"ç¼©å£"è€Œä¸æ˜¯"æ‰©å£"

### 3. **Armedé‡ç½®æ¡ä»¶**

**ä¿®æ”¹å‰**ï¼š
- è·Œç ´ä¸‹è½¨ OR å®½åº¦ä¸å†æ»¡è¶³æ¡ä»¶

**ä¿®æ”¹å**ï¼š
- **ä»…å½“è·Œç ´ä¸‹è½¨æ—¶é‡ç½®**
- è¿›å…¥å†·å´æœŸï¼Œé‡æ–°ç­‰å¾…ä¸‹ä¸€æ¬¡Armedè§¦å‘

### 4. **æ•°æ®åˆ—æ›´æ–°**

#### ç§»é™¤çš„åˆ—ï¼ˆ4hç›¸å…³ï¼‰ï¼š
- `date_4h`, `open_4h`, `high_4h`, `low_4h`, `close_4h`, `volume_4h`
- `bb_upper_4h`, `bb_middle_4h`, `bb_lower_4h`, `bb_width_4h`
- `is_width_ok_4h`, `is_breakout_4h`, `is_below_lower_4h`
- `is_armed_4h`, `armed_active_4h`

#### æ–°å¢çš„åˆ—ï¼ˆå®æ—¶è®¡ç®—ï¼‰ï¼š
- `bb_width` - å¸ƒæ—å¸¦å®½åº¦ï¼ˆå®æ—¶è®¡ç®—ï¼‰
- `is_width_ok` - ç¼©å£åˆ¤æ–­ï¼ˆ< é˜ˆå€¼ï¼‰
- `is_breakout` - çªç ´ä¸Šè½¨
- `is_below_lower` - è·Œç ´ä¸‹è½¨
- `is_armed` - Armedç¬æ—¶è§¦å‘
- `armed_active` - ArmedæŒç»­çŠ¶æ€ï¼ˆç²˜æ€§ï¼‰

---

## ğŸ“ ç­–ç•¥é€»è¾‘è¯¦è§£

### **å®Œæ•´çš„çŠ¶æ€æœºæµç¨‹**

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   å¾…æœºçŠ¶æ€      â”‚
                    â”‚ (armed_active   â”‚
                    â”‚   = False)      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    âœ… è§¦å‘æ¡ä»¶ï¼š
                    ç¼©å£ï¼ˆå®½åº¦ < 4.5%ï¼‰
                         AND
                    çªç ´ä¸Šè½¨ï¼ˆæ”¶ç›˜ä»· > ä¸Šè½¨ï¼‰
                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”Œâ”€â”€â”€â”€â”€â–ºâ”‚   ArmedçŠ¶æ€     â”‚
             â”‚      â”‚ (armed_active   â”‚
             â”‚      â”‚   = True)       â”‚
             â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚               â”‚
             â”‚        ç´¯ç§¯1h Kçº¿
             â”‚        è®¡ç®—HLHç»“æ„
             â”‚               â”‚
             â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚      â”‚  æ£€æµ‹HLHå½¢æ€     â”‚
             â”‚      â”‚  + Armed = True  â”‚
             â”‚      â”‚  â†’ å…¥åœºä¿¡å·      â”‚
             â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚               â”‚
             â”‚      âš ï¸ é‡ç½®æ¡ä»¶ï¼š
             â”‚      è·Œç ´ä¸‹è½¨ï¼Ÿ
             â”‚               â”‚
             â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚  Yes â”‚                 â”‚ No
             â””â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€ æŒç»­Armed
```

### **å…³é”®å‚æ•°**

| å‚æ•°å | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|--------|------|
| `width_threshold` | 0.045 (4.5%) | ç¼©å£é˜ˆå€¼ï¼š(ä¸Šè½¨-ä¸‹è½¨)/ä¸­è½¨ < 4.5% |
| `bb_period` | 20 | å¸ƒæ—å¸¦å‘¨æœŸ |
| `bb_stdev` | 2.0 | å¸ƒæ—å¸¦æ ‡å‡†å·®å€æ•° |
| `stoploss` | -0.01 (-1%) | ç¡¬æ­¢æŸ |
| `cooldown_bars` | 2 | å†·å´æœŸï¼ˆå°æ—¶ï¼‰ |

---

## ğŸ” å®æˆ˜ç¤ºä¾‹

### **åœºæ™¯ï¼šå¸ƒæ—å¸¦ç¼©å£åçªç ´**

```
æ—¶é—´è½´ï¼š1h Kçº¿

09:00  å®½åº¦=3.8%, æ”¶ç›˜ä»·=99.5, ä¸Šè½¨=100 â†’ ç¼©å£ä½†æœªçªç ´
10:00  å®½åº¦=3.5%, æ”¶ç›˜ä»·=100.5, ä¸Šè½¨=100 â†’ âœ… Armedè§¦å‘ï¼
       armed_active = True, å¼€å§‹ç´¯ç§¯1h Kçº¿

11:00  armed_active=True, ç´¯ç§¯2æ ¹Kçº¿ â†’ ç»“æ„åˆå¹¶
12:00  armed_active=True, ç´¯ç§¯3æ ¹Kçº¿ â†’ æ£€æµ‹åˆ°HLHå½¢æ€ âœ…
       â†’ å…¥åœºä¿¡å·ï¼

13:00  ä»·æ ¼ä¸‹è·Œè‡³99, ä¸‹è½¨=98.5 â†’ ä»åœ¨ArmedçŠ¶æ€
14:00  ä»·æ ¼ç»§ç»­ä¸‹è·Œè‡³98, ä¸‹è½¨=98.5 â†’ âš ï¸ è·Œç ´ä¸‹è½¨
       â†’ Armedé‡ç½®, è¿›å…¥å†·å´æœŸ2å°æ—¶

16:00  å†·å´æœŸç»“æŸ, ç­‰å¾…ä¸‹ä¸€æ¬¡Armedè§¦å‘
```

### **ç¼©å£åˆ¤æ–­ç¤ºä¾‹**

```
è®¡ç®—å…¬å¼ï¼šbb_width = (bb_upper - bb_lower) / bb_middle

ç¤ºä¾‹1ï¼š
ä¸Šè½¨=102, ä¸­è½¨=100, ä¸‹è½¨=98
å®½åº¦ = (102-98)/100 = 0.04 = 4%
åˆ¤æ–­ï¼š4% < 4.5% â†’ âœ… ç¼©å£

ç¤ºä¾‹2ï¼š
ä¸Šè½¨=105, ä¸­è½¨=100, ä¸‹è½¨=95
å®½åº¦ = (105-95)/100 = 0.10 = 10%
åˆ¤æ–­ï¼š10% > 4.5% â†’ âŒ ä¸ç¬¦åˆç¼©å£æ¡ä»¶
```

---

## ğŸ“Š å¯¼å‡ºæ•°æ®æ›´æ–°

### **CSVæ–‡ä»¶åˆ—åå¯¹ç…§**

| è‹±æ–‡åˆ—å | ä¸­æ–‡åˆ—å | è¯´æ˜ |
|---------|---------|------|
| `bb_upper` | å¸ƒæ—ä¸Šè½¨ | 1hå®æ—¶è®¡ç®— |
| `bb_middle` | å¸ƒæ—ä¸­è½¨ | 1hå®æ—¶è®¡ç®— |
| `bb_lower` | å¸ƒæ—ä¸‹è½¨ | 1hå®æ—¶è®¡ç®— |
| `bb_width` | å¸ƒæ—å®½åº¦ | (ä¸Šè½¨-ä¸‹è½¨)/ä¸­è½¨ |
| `is_width_ok` | å®½åº¦ç¼©å£ | True=å®½åº¦<é˜ˆå€¼ |
| `is_breakout` | çªç ´ä¸Šè½¨ | True=æ”¶ç›˜ä»·>ä¸Šè½¨ |
| `is_below_lower` | è·Œç ´ä¸‹è½¨ | True=æ”¶ç›˜ä»·<=ä¸‹è½¨ |
| `is_armed` | Armedè§¦å‘ | ç¬æ—¶è§¦å‘ä¿¡å· |
| `armed_active` | ArmedæŒç»­ | ç²˜æ€§çŠ¶æ€ |

---

## âš™ï¸ ä»£ç ä¿®æ”¹è¦ç‚¹

### 1. **æ–°å¢æ–¹æ³•ï¼š`populate_indicators_1h_bb`**

```python
def populate_indicators_1h_bb(self, dataframe: DataFrame, metadata: dict) -> DataFrame:
    """å®æ—¶è®¡ç®—1hå¸ƒæ—å¸¦æŒ‡æ ‡"""
    # åŸºäº1hæ”¶ç›˜ä»·è®¡ç®—å¸ƒæ—å¸¦
    bollinger = qtpylib.bollinger_bands(
        dataframe['close'],
        window=self.bb_period.value,
        stds=self.bb_stdev.value
    )
    
    # å®æ—¶åˆ¤æ–­æ¡ä»¶
    dataframe['is_width_ok'] = dataframe['bb_width'] < self.width_threshold.value  # ç¼©å£
    dataframe['is_breakout'] = dataframe['close'] > dataframe['bb_upper']  # çªç ´ä¸Šè½¨
    dataframe['is_below_lower'] = dataframe['close'] <= dataframe['bb_lower']  # è·Œç ´ä¸‹è½¨
    dataframe['is_armed'] = dataframe['is_width_ok'] & dataframe['is_breakout']  # Armedè§¦å‘
    
    return dataframe
```

### 2. **é‡æ„ï¼š`populate_indicators`**

**ç§»é™¤**ï¼š
- 4hæ•°æ®è·å– (`dp.get_pair_dataframe(timeframe='4h')`)
- 4hæ•°æ®åˆå¹¶é€»è¾‘
- 4håˆ—é‡å‘½å

**æ–°å¢**ï¼š
- ç›´æ¥è°ƒç”¨ `populate_indicators_1h_bb`
- ç®€åŒ–çš„ArmedçŠ¶æ€æœºï¼ˆåŸºäº1hæ•°æ®ï¼‰

### 3. **æ›´æ–°ï¼šArmedçŠ¶æ€æœº**

```python
for i in range(len(dataframe)):
    is_armed = bool(dataframe['is_armed'].iloc[i])
    is_below = bool(dataframe['is_below_lower'].iloc[i])
    
    if is_armed:
        current_state = True  # Armedè§¦å‘
        logger.info(f"Armedè§¦å‘ @ {dataframe['date'].iloc[i]}")
    elif is_below:
        if current_state:
            logger.info(f"Armedé‡ç½®ï¼ˆè·Œç ´ä¸‹è½¨ï¼‰@ {dataframe['date'].iloc[i]}")
        current_state = False  # é‡ç½®æ¡ä»¶ï¼šè·Œç ´ä¸‹è½¨
    
    armed_active.iloc[i] = current_state
```

### 4. **æ›´æ–°ï¼šHLHç»“æ„è®¡ç®—**

å°† `armed_active_4h` æ”¹ä¸º `armed_active`ï¼š

```python
is_armed_now = bool(dataframe['armed_active'].iloc[i])
```

### 5. **æ›´æ–°ï¼šå‡ºåœºé€»è¾‘**

å°† `is_below_lower_4h` æ”¹ä¸º `is_below_lower`ï¼š

```python
if bool(latest.get('is_below_lower', False)):
    # è·Œç ´ä¸‹è½¨ï¼Œå‡ºåœº
```

---

## ğŸ¯ ä¼˜åŠ¿ä¸æ”¹è¿›

### **ä¼˜åŠ¿**

âœ… **æ›´å¿«å“åº”**ï¼š1hå®æ—¶è®¡ç®—ï¼Œä¸éœ€è¦ç­‰å¾…4hå‘¨æœŸå®Œæˆ  
âœ… **æ›´çµæ´»**ï¼šæ¯å°æ—¶éƒ½é‡æ–°è¯„ä¼°å¸ƒæ—å¸¦çŠ¶æ€  
âœ… **æ›´ç²¾ç¡®**ï¼šåŸºäºå½“å‰æœ€æ–°æ•°æ®ï¼Œé¿å…4håˆå¹¶çš„æ»åæ€§  
âœ… **æ›´ç®€å•**ï¼šç§»é™¤å¤æ‚çš„4hæ•°æ®åˆå¹¶é€»è¾‘ï¼Œä»£ç æ›´æ¸…æ™°  

### **æ”¹è¿›å»ºè®®**

1. **è°ƒæ•´ `width_threshold` å‚æ•°**
   - ä»4hæ‰©å£ï¼ˆ9%ï¼‰æ”¹ä¸º1hç¼©å£ï¼ˆ4.5%ï¼‰
   - å¯ä»¥æ ¹æ®å›æµ‹ç»“æœä¼˜åŒ–æ­¤é˜ˆå€¼

2. **ç›‘æ§Armedè§¦å‘é¢‘ç‡**
   - å®æ—¶è®¡ç®—å¯èƒ½å¯¼è‡´Armedè§¦å‘æ›´é¢‘ç¹
   - å¯ä»¥é€šè¿‡å¢åŠ å†·å´æœŸæˆ–æé«˜é˜ˆå€¼æ¥æ§åˆ¶

3. **ä¼˜åŒ–HLHæ£€æµ‹**
   - 1hç´¯ç§¯å¯èƒ½å¯¼è‡´HLHå½¢æ€æ›´å°ã€æ›´å¿«
   - å¯ä»¥è°ƒæ•´æœ€å°ç´¯ç§¯é•¿åº¦ï¼ˆç›®å‰â‰¥3æ ¹ï¼‰

---

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### **1. è¿è¡Œå›æµ‹**

```powershell
freqtrade backtesting `
  --strategy Bollinger4h1hStructureStrategy `
  --config user_data/config_bollinger_4h1h.json `
  --timerange 20241010-20251010 `
  --export trades
```

### **2. æŸ¥çœ‹å¯¼å‡ºæ•°æ®**

CSVæ–‡ä»¶è·¯å¾„ï¼š
```
user_data/debug/BollingerHLH_<äº¤æ˜“å¯¹>_1h_full.csv
```

### **3. åˆ†æå…³é”®åˆ—**

é‡ç‚¹å…³æ³¨ï¼š
- `å¸ƒæ—å®½åº¦`ï¼šè§‚å¯Ÿç¼©å£æ—¶æœº
- `Armedè§¦å‘`ï¼šæŸ¥çœ‹è§¦å‘é¢‘ç‡
- `ArmedæŒç»­`ï¼šåˆ†ææŒç»­æ—¶é•¿
- `HLHä¿¡å·`ï¼šæ£€æŸ¥å½¢æ€å‡ºç°æ—¶æœº

---

## ğŸ“ æ³¨æ„äº‹é¡¹

âš ï¸ **å®½åº¦åˆ¤æ–­æ”¹å˜**ï¼šä» `>=` æ”¹ä¸º `<`ï¼Œç°åœ¨æ˜¯åˆ¤æ–­"ç¼©å£"  
âš ï¸ **é‡ç½®æ¡ä»¶ç®€åŒ–**ï¼šåªæœ‰è·Œç ´ä¸‹è½¨æ‰é‡ç½®ï¼Œä¸å†æ£€æŸ¥å®½åº¦  
âš ï¸ **å‚æ•°éœ€è¦é‡æ–°ä¼˜åŒ–**ï¼š1hè®¡ç®—çš„æœ€ä½³å‚æ•°å¯èƒ½ä¸4hä¸åŒ  
âš ï¸ **å›æµ‹æ•°æ®ä¸å…¼å®¹**ï¼šæ—§çš„å›æµ‹ç»“æœæ— æ³•ä¸æ–°ç­–ç•¥å¯¹æ¯”  

---

## ğŸ”§ æ•…éšœæ’é™¤

### Q: Armedè§¦å‘å¤ªé¢‘ç¹ï¼Ÿ
**A**: å¢å¤§ `width_threshold` æˆ–å¢åŠ  `cooldown_bars`

### Q: ä»æœªè§¦å‘Armedï¼Ÿ
**A**: é™ä½ `width_threshold`ï¼Œæˆ–æ£€æŸ¥æ•°æ®æ˜¯å¦æ­£å¸¸

### Q: HLHä¿¡å·å¾ˆå°‘ï¼Ÿ
**A**: ArmedæŒç»­æ—¶é—´å¯èƒ½å¤ªçŸ­ï¼Œè€ƒè™‘æ”¾å®½è·Œç ´ä¸‹è½¨çš„å®¹å¿åº¦

### Q: CSVæ–‡ä»¶æ²¡æœ‰æ–°åˆ—ï¼Ÿ
**A**: ç¡®ä¿æ¸…é™¤æ—§çš„å›æµ‹ç»“æœï¼Œé‡æ–°è¿è¡Œå›æµ‹

---

## ğŸ“Œ æ€»ç»“

ç­–ç•¥å·²æˆåŠŸä»4hå‘¨æœŸåˆå¹¶æ¨¡å¼è¿ç§»åˆ°1hå®æ—¶è®¡ç®—æ¨¡å¼ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

- âœ… **å®æ—¶å“åº”**ï¼šæ¯å°æ—¶é‡æ–°è®¡ç®—å¸ƒæ—å¸¦
- âœ… **ç®€åŒ–é€»è¾‘**ï¼šç§»é™¤å¤æ‚çš„4hæ•°æ®åˆå¹¶
- âœ… **æ˜ç¡®æ¡ä»¶**ï¼šç¼©å£ + çªç ´ä¸Šè½¨ = Armed
- âœ… **æ¸…æ™°é‡ç½®**ï¼šä»…è·Œç ´ä¸‹è½¨æ—¶é‡ç½®

å»ºè®®é€šè¿‡å›æµ‹éªŒè¯æ–°ç­–ç•¥çš„è¡¨ç°ï¼Œå¹¶æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´å‚æ•°ï¼ğŸ‰




